name: Build F* and test related projects
on:
  # push:
  workflow_dispatch:
  workflow_call:

# TODO:
# Is there a way to set the default container?
# Move to the regular fstar-ci-base too

defaults:
  run:
    shell: bash

jobs:
  build-fstar:
    runs-on: []
    container: mtzguido/fstar-base-testing
    steps:
      - name: Cleanup
        run: find . -delete
      - run: echo "HOME=/home/opam" >> $GITHUB_ENV
      - uses: mtzguido/set-opam-env@master

      - name: Checkout
        uses: actions/checkout@master
        with:
          path: FStar/

      - name: Prep
        run: |
          # In case we edited fstar.opam, install new deps here
          # This will most likely fail to like krml below, what's going on?
          # opam install --confirm-level=unsafe-yes --deps-only ./FStar/fstar.opam
      - name: Build
        run: make -C FStar -skj$(nproc)

      - uses: mtzguido/gci-upload@master
        with:
          name: FStar
          extra: --exclude=FStar/ocaml/_build
