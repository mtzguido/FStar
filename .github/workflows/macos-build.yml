name: Build F* (macos)

on:
  push:
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Cleanup
        run: sudo find . -delete
      - run: echo "HOME=/home/user" >> $GITHUB_ENV
      - uses: mtzguido/set-opam-env@master

      - name: Checkout
        uses: actions/checkout@master
        with:
          path: FStar

      - name: Produce all artifacts
        run: make -skj$(nproc) package package-src FSTAR_VERSION=ci
        working-directory: FStar

      - uses: actions/upload-artifact@v4
        with:
          path: FStar/fstar-ci.tar.gz
          name: fstar-ci-macos.tar.gz
          retention-days: 3
      - uses: actions/upload-artifact@v4
        with:
          path: FStar/fstar-ci-src.tar.gz
          name: fstar-ci-macos-src.tar.gz
          retention-days: 3
